---
title: "steps showcase"
output:
  html_document:
    toc: yes
    toc_float: yes
    theme: united
  pdf_document:
    toc: yes
---

  ```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-"
)
```
```{r, include = FALSE}
# load alle relevante pakker.
library(dplyr)
library(recipes)
library(DT)
library(magrittr)
library(purrr)
devtools::load_all()
```

# Formål

Formålet med dette skriv er at undersøge virkemåden for relevante steps i pakken `recipes`, der tilbyder et 
fleksibelt framework til præprocessering i forbindelse med modeludvikling (og specielt sammen med `caret`).

Alle steps er beskrevet i [dokumentationen for 'recipes'](https://cran.r-project.org/web/packages/recipes/recipes.pdf).

## Oversigt over relevante steps

Vi har identificeret en delmængde af de understøttede steps, der kunne være relevante i udviklingen af vores 
Compliance-modeller. En oversigt over disse følger her:

step_navn     | Kategori     | Beskrivelse                                                           |
------------- | -------------| ----------------------------------------------------------------------|
[step_bagimpute](#step_bagimpute) | Imputation | Imputer alle typer af features ved hjælp af bagged trees |
[step_corr](#step_corr) | Dimensionsreduktion | Fjern features med høj korrelation |
[step_dummy](#step_dummy) | Kategoriske variable | One-hot-encoding af  factors/characters |
[step_ica](#step_ica) | Dimensionsreduktion | Transformér numeriske variable vha. ICA Signal Extraction |
[step_interact](#step_ica) | Transformation | Dan interaktioner mellem features |
[step_knnimpute](#step_knnimpute) | Imputation | Imputér variable vha. af nærmeste nabo-model |
[step_meanmpute](#step_meanimpute) | Imputation | Imputér variable til deres gennemsnit |
[step_modeimpute](#step_modeimpute) | Imputation | Imputér variable til hyppigst forekommende værdi |
[step_novel](#step_novel) | Transformation | Indsæt ekstra niveau (til opsamling) i alle kategoriske variable |
[step_num2factor](#step_num2factor) | Kategoriske variable | Lav numerisk variabel om til kategorisk med lige mange observationer i hver kategori |
[step_nzv](#step_nzv) | Dimensionsreduktion | Fjern variable med "lav varians" |
[step_other](#step_other) | Kategoriske variable | Lav "Other"-kategori, der samler tyndt populerede kategorier til én kategori|
[step_pca](#step_pca) | Dimensionsreduktion | Transformér numeriske variable vha. Principal Component Analysis |
[step_ratio](#step_ratio) | Transformation | Dan ratios mellem numeriske features |
[step_rm](#step_rm) | Dimensionsreduktion | Fjern navngivne variable eller variable af bestemt type osv. |
[step_spatialsign](#step_spatialsign) | Transformation | Transformér numeriske variable vha. Spatial Sign-teknik |
[step_string2factor](#step_string2factor) | Kategoriske variable |  Lav characters til factors |
[step_zv](#step_zv) | Dimensionsreduktion | Fjern variable med nul varians |

Vi får brug for et diversificeret datasæt til at afprøve de forskellige steps. 

Simulér data:

```{r}
df <- 
  dplyr::bind_cols(simulate_numerics(), simulate_characters(), simulate_characters(to_factor = TRUE)) %>%
  simulate_NAs(names(.))

DT::datatable(df)
```

I det følgende sættes de forskellige steps under lup én for én.

### step_meanimpute {#step_meanimpute}


Lav og følg opskrift:

```{r}
# prepare recipe.
rec <- 
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_meanimpute(all_numeric()) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% DT::datatable(.)
```

**Bemærkninger**: Imputerer (selvsagt) kun numeriske variable.

### step_bagimpute {#step_bagimpute}


Lav og følg opskrift:


```{r}
# prepare recipe.
rec <- 
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_bagimpute(all_predictors()) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% DT::datatable(.)
```

**Bemærkninger**: Imputerer numeriske og kategoriske variable. Characters modificeres ikke.


### step_knnimpute {#step_knnimpute}


Lav og følg opskrift:


```{r}
# prepare recipe.
rec <-
  recipe(~ num2 + num3, data = df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_knnimpute(all_numeric(), all_nominal()) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% DT::datatable(.)
```

**Bemærkninger**: Imputerer numeriske variable - ikke characters og factors. Imputation kan ske under anvendelse af 
en kombination af numeriske variable og faktor-variable. Er enten ringe implementeret, eller også forstår jeg ikke
at anvende funktionen.

### step_corr {#step_corr}

Lav og følg opskrift:


```{r}
# prepare recipe.
rec <-
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_corr(all_numeric(), threshold = 0.6) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% DT::datatable(.)
```

**Bemærkninger**: Virker kun med numeric. 'Threshold' angiver tærskelværdi for korrelation.

### step_dummy {#step_dummy}

Lav og følg opskrift:


```{r}
# prepare recipe.
rec <-
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_modeimpute(all_nominal()) %>%
  step_dummy(all_nominal()) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% DT::datatable(.)
```

**Bemærkninger**: Virker med characters og factors (= nominals). Variablene skal dog imputeres først. Fuld rang på
dummy-matricerne som man siger. Konvertering til numerisk.

### step_modeimpute {#step_modeimpute}

Lav og følg opskrift:


```{r}
# prepare recipe.
rec <-
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_modeimpute(all_nominal()) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% DT::datatable(.)
```

**Bemærkninger**: Virker med characters og factors (= nominals). Characters konverteres automatisk til factors.

### step_ica {#step_ica}

Lav og følg opskrift:


```{r}
# prepare recipe.
rec <-
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_meanimpute(all_numeric()) %>%
  step_ica(all_numeric(), num = 2) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% DT::datatable(.)
```

**Bemærkninger**: Virker kun med numerics. Antallet af komponenter styres med 'num'. Accepterer ikke NA-værdier i input. Dropper automatisk input-variable.

### step_interact {#step_interact}

Lav og følg opskrift:


```{r}
# prepare recipe.
rec <-
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_interact(terms = ~ num1:fct1 + char2:fct2 + num1:num3) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% DT::datatable(.)
```

**Bemærkninger**: Kan kombinere numerics, chars og factors. Men brug af nominelle variable frarådes. Nominelle variable indgår som dummy-variable.

### step_novel {#step_novel}

Lav og følg opskrift:


```{r}
# prepare recipe.
rec <-
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_novel(all_nominal()) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% dplyr::select(-contains("num")) %>% purrr::map(levels)
```

**Bemærkninger**: Virker med nominelle variable. Chars konverteres til factors. Alle får allokeret et ekstra niveau: "new".

### step_num2factor {#step_num2factor}

Lav og følg opskrift:


```{r}
# prepare recipe.
rec <-
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_num2factor(all_numeric()) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% dplyr::select(contains("num")) %>% purrr::map_chr(class)
```

**Bemærkninger**: Konverterer råt for usødet numeriske variable til factors.

### step_nzv {#step_nzv}

Lav og følg opskrift:


```{r}
# customize dataset.
df_cust <- df
df_cust[["num1"]][3:50] <- 0
df_cust[["num2"]][3:50] <- NA_real_
df_cust[["num3"]][1:50] <- NA_real_
df_cust[["char1"]][3:50] <- "a"
df_cust[["char2"]][3:50] <- NA_character_
df_cust[["char3"]][1:50] <- NA_character_
df_cust[["fct1"]][3:50] <- "a"
df_cust[["fct2"]][3:50] <- NA
df_cust[["fct3"]][1:50] <- NA

# prepare recipe.
rec <-
  recipe(df_cust) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_nzv(everything(), options = list(freq_cut = 95/5, unique_cut = 10)) %>%
  prep(.)

# bake recipe.
bake(rec, df_cust) %>% DT::datatable(.)
```

**Bemærkninger**: Virker med både numeriske, characters og factors. Konverterer characters til factors 'under the hood'. Bortser fra NA-indgange i beregningerne. Variable, der udelukkende indeholder NA-værdier, frafiltreres.

### step_other {#step_other}

Lav og følg opskrift:


```{r}
# customize dataset.
df_cust <- df
df_cust[["char1"]][1] <- "x"
df_cust[["char2"]][2] <- "y"
df_cust[["fct1"]] <- df_cust[["char1"]] %>% as.factor(.)
df_cust[["fct2"]] <- df_cust[["char2"]] %>% as.factor(.)

# prepare recipe.
rec <-
  recipe(df_cust) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_other(everything()) %>%
  prep(.)

# bake recipe.
bake(rec, df_cust) %>% DT::datatable(.)
```

**Bemærkninger**: ADVARSEL! Virker både med characters, numerics (!!!) og factors. Bør ikke bruges på kontinuerte variable. Characters og numerics konverteres pr. automatik til factors.

### step_pca {#step_pca}

Lav og følg opskrift:


```{r}
# prepare recipe.
rec <-
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_meanimpute(all_numeric()) %>%
  step_pca(all_numeric(), threshold = 0.8) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% DT::datatable(.)
```

**Bemærkninger**: Virker kun med numerics. Antallet af komponenter styres med 'num' eller vha. 'threshold' (hvor stor en del af variationen skal kunne forklares af dekomponeringen). Accepterer ikke NA-værdier i input. Dropper automatisk input-variable.

### step_ratio {#step_ratio}

Lav og følg opskrift:


```{r}
# prepare recipe.
rec <-
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_ratio(all_numeric(), denom = denom_vars(num2, num3)) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% select(contains("num")) %>% DT::datatable(.)
```

**Bemærkninger**: Virker sammen med numerics. Der laves ikke en brøk for tilfældet y = x/x.

### step_rm {#step_rm}

Lav og følg opskrift:

```{r}
# prepare recipe.
rec <-
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_rm(all_numeric(), contains("char"), fct4) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% DT::datatable(.)
```

**Bemærkninger**: Virker sammen med f.eks. "all_numeric()", regex og navngivne kolonner vha. almindelig tidy eval.

### step_spatialsign {#step_spatialsign}

Lav og følg opskrift:


```{r}
# prepare recipe.
rec <-
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_spatialsign(all_numeric(), na.rm = TRUE) %>%
  prep(.)

# bake recipe.
bake(rec, df) %>% DT::datatable(.)
```

**Bemærkninger**: Virker kun med numerics. Overskriver eksisterende variable med ss-transformationen. Accepterer som udgangspunkt NA. Argument 'na.rm' styrer håndtering af NA.

### step_string2factor {#step_string2factor}

Lav og følg opskrift:


```{r, error = TRUE}
# prepare recipe.
rec <-
  recipe(df) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_string2factor("num1") %>%
  prep(.)

# bake recipe.
# bake(rec, df) %>% select(contains("char")) %>% purrr::map_chr(class)
```

**Bemærkninger**: Hmm... Får fejlbesked. Kuriøs implmentation?

### step_zv {#step_zv}

Lav og følg opskrift:


```{r}
# customize dataset.
df_cust <- df
df_cust[["num1"]][1:50] <- 0
df_cust[["num2"]][1:50] <- NA_real_
df_cust[["char1"]][1:50] <- "a"
df_cust[["char2"]][1:50] <- NA_character_
df_cust[["fct1"]][1:50] <- "a"
df_cust[["fct2"]][1:50] <- NA

# prepare recipe.
rec <-
  recipe(df_cust) %>%
  add_role(everything(), new_role = "predictor") %>%
  step_nzv(everything()) %>%
  prep(.)

# bake recipe.
bake(rec, df_cust) %>% DT::datatable(.)
```

**Bemærkninger**: Virker med både numeriske, characters og factors. Konverterer characters til factors 'under the hood'. Fjerner kolonner, der kun indeholder NA-værdier.






